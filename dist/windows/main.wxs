<?xml version="1.0"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

   <Product Id="*" 
            UpgradeCode="e43d274f-c34f-42d2-9480-591a9415e86d"
            Name="Prey Anti-theft"
            Version="$(var.ProductVersion)"
            Manufacturer="Prey, Inc."
            Language="1033">
      <Package  InstallerVersion="200"
                Compressed="yes"
                Comments="Windows Installer Package"/>
      <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>
 
      <!-- Dot Net condition -->
      <PropertyRef Id="NETFRAMEWORK20_SP_LEVEL"/>
      <Condition Message='This setup requires the .NET Framework 2.0 with Service Pack 1 installed.'>
         <![CDATA[Installed OR (NETFRAMEWORK20_SP_LEVEL AND NETFRAMEWORK20_SP_LEVEL = "#1")]]>
      </Condition>

      <Directory Id="TARGETDIR" Name="SourceDir">

         <Directory Id="ProgramFilesFolder">
            <Directory Id="Prey" Name="Prey">
               <Directory Id="Versions" Name="Versions">
                  <Directory Id="INSTALLDIR" Name="$(var.ProductVersion)">
                  </Directory>
               </Directory>
            </Directory>
         </Directory>

         <Directory Id="WindowsFolder" Name="WindowsFolder">
            <Directory Id="WinPrey" Name="Prey">
               <Component  Id="WinPreyDirCreation"
                           Guid="cd6e15d0-daf6-11e2-a28f-0800200c9a66">
                  <CreateFolder />
                  <RemoveFile Id="WinPreyConf" Name="prey.conf" On="uninstall" />
                  <RemoveFolder Id='WinPrey' On='uninstall' />
               </Component>
            </Directory>
         </Directory>

      </Directory>
 
      <Feature Id="Complete" Level="1">
         <ComponentGroupRef Id="prey_msi"/>
         <ComponentRef Id="WinPreyDirCreation" />
      </Feature>

      <!-- The commands to be executed after installation -->
      <!-- bin\prey.cmd config activate -->
      <CustomAction  Id="CommandConfigActivate"
                     Directory="INSTALLDIR"
                     ExeCommand="&quot;[INSTALLDIR]bin\prey.cmd&quot; config activate"
                     Execute="deferred"
                     Impersonate="no"
                     Return="asyncWait" />

      <!-- bin\prey.cmd hooks post_install -->
      <CustomAction  Id="CommandHooksPostInstall"
                     Directory="INSTALLDIR"
                     ExeCommand="&quot;[INSTALLDIR]bin\prey.cmd&quot; hooks post_install"
                     Execute="deferred"
                     Impersonate="no"
                     Return="asyncWait" />

      <!-- bin\prey.cmd config gui -->
      <CustomAction  Id="CommandConfigGui"
                     Directory="INSTALLDIR"
                     ExeCommand="&quot;[INSTALLDIR]bin\prey.cmd&quot; config gui"
                     Execute="deferred"
                     Impersonate="no"
                     Return="asyncWait" />

      <InstallExecuteSequence>
         <Custom  Action='CommandConfigActivate'
                  After='PublishProduct'>NOT Installed</Custom>
         <!-- Custom  Action='CommandHooksPostInstall'
                  After='PublishProduct'>NOT Installed</Custom -->
         <Custom  Action='CommandConfigGui'
                  After='PublishProduct'>NOT Installed</Custom>
      </InstallExecuteSequence>

   </Product>
</Wix>